{% extends 'base.html' %}
{% load static format_filters %}

{% block content %}
<div class="container">
    <h1 class="my-4">Crypto Market Overview</h1>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    {% if is_data_live %}
        <!-- Market Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body">
                        <h5 class="card-title">Total Coins</h5>
                        <p class="stat-value" id="totalCoins">{{ market_data|length }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body">
                        <h5 class="card-title">Market Cap</h5>
                        <p class="stat-value" id="marketCap">$0.00</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body">
                        <h5 class="card-title">24h Volume</h5>
                        <p class="stat-value" id="totalVolume">$0.00</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body">
                        <h5 class="card-title">Market Sentiment</h5>
                        <p class="stat-value" id="marketSentiment">Neutral</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Market Table -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Market Data</h5>
                <div>
                    <input type="text" id="filterInput" class="form-control d-inline-block" style="width: 200px;" placeholder="Filter coins...">
                    <select id="sortSelect" class="form-select d-inline-block" style="width: 150px;">
                        <option value="name">Sort by Name</option>
                        <option value="price">Sort by Price</option>
                        <option value="change">Sort by 24h Change</option>
                        <option value="volume">Sort by Volume</option>
                    </select>
                    <button id="refreshTable" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <span id="tableLoader" class="spinner-border spinner-border-sm" style="display: none;"></span>
                    <span class="text-muted small ms-2">Last updated: <span id="lastUpdate">{{ 'now'|date:"H:i:s" }}</span></span>
                </div>
            </div>
            <div class="card-body">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Coin</th>
                            <th>Price (USD)</th>
                            <th>24h Change</th>
                            <th>24h Volume</th>
                            <th>Sentiment</th>
                            <th>Chart</th>
                        </tr>
                    </thead>
                    <tbody id="marketTableBody">
                        {% for coin_id, data in market_data.items %}
                        <tr class="animate-row" style="--row-index: {{ forloop.counter0 }};">
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="crypto-icon me-3">
                                        <i class="fab fa-bitcoin" style="color: var(--accent-primary);"></i>
                                    </div>
                                    <div>
                                        <a href="{% url 'live_charts' %}?coin={{ coin_id }}" class="coin-link fw-bold">
                                            {{ data.name }}
                                        </a>
                                        <div class="text-muted small">{{ coin_id|upper }}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="price-badge price-slide" data-coin="{{ coin_id }}">
                                    ${{ data.usd|format_currency }}
                                </span>
                            </td>
                            <td>
                                <span class="change-badge" data-coin="{{ coin_id }}">
                                    {{ data.usd_24h_change|floatformat:2 }}%
                                </span>
                            </td>
                            <td class="text-secondary">${{ data.volume_24h|format_number }}</td>
                            <td>
                                <span class="sentiment-badge sentiment-{{ data.sentiment|lower }}" data-coin="{{ coin_id }}">
                                    {{ data.sentiment|default:'Neutral' }}
                                </span>
                            </td>
                            <td>
                                <a href="{% url 'live_charts' %}?coin={{ coin_id }}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-chart-area"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Price Pie Chart -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Price Distribution</h5>
                <div>
                    <button id="chartToggle" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-chart-pie"></i>
                    </button>
                    <button id="refreshChart" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <span id="chartLoader" class="spinner-border spinner-border-sm" style="display: none;"></span>
                </div>
            </div>
            <div class="card-body">
                <canvas id="pricePieChart" height="400"></canvas>
            </div>
        </div>
    {% else %}
        <div class="alert alert-warning">
            No market data available. Please try again later.
        </div>
    {% endif %}
</div>

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Enhanced Chart Configuration
    {% if is_data_live %}
    const ctx = document.getElementById('pricePieChart')?.getContext('2d');
    let currentChart = null;
    let chartType = 'pie';

    function createChart(type = 'pie') {
        if (currentChart) {
            currentChart.destroy();
        }

        const config = {
            type: type,
            data: {
                labels: [{% for coin_id, data in market_data.items %}'{{ data.name }}',{% endfor %}],
                datasets: [{
                    data: [{% for coin_id, data in market_data.items %}{{ data.usd }},{% endfor %}],
                    backgroundColor: [
                        'rgba(0, 212, 255, 0.8)',
                        'rgba(255, 107, 107, 0.8)',
                        'rgba(0, 255, 133, 0.8)',
                        'rgba(255, 204, 2, 0.8)',
                        'rgba(153, 102, 255, 0.8)',
                        'rgba(255, 159, 64, 0.8)'
                    ],
                    borderColor: 'rgba(255, 255, 255, 0.2)',
                    borderWidth: 2,
                    hoverOffset: 20
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: 'var(--text-color)',
                            font: {
                                size: 14,
                                family: "'Inter', sans-serif"
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(20, 20, 20, 0.95)',
                        borderColor: 'var(--accent-primary)',
                        borderWidth: 1,
                        borderRadius: 12,
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                return `${label}: $${value.toFixed(2)}`;
                            }
                        }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                }
            }
        };

        if (type === 'bar') {
            config.options.scales = {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'var(--text-secondary)',
                        callback: function(value) {
                            return `$${value}`;
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: 'var(--text-secondary)'
                    }
                }
            };
        }

        currentChart = new Chart(ctx, config);
    }

    // Initialize chart
    if (ctx) {
        createChart(chartType);
    }

    // Chart toggle
    const chartToggle = document.getElementById('chartToggle');
    if (chartToggle) {
        chartToggle.addEventListener('click', function() {
            chartType = chartType === 'pie' ? 'bar' : 'pie';
            createChart(chartType);
            this.innerHTML = chartType === 'pie' ? 
                '<i class="fas fa-chart-bar"></i>' : 
                '<i class="fas fa-chart-pie"></i>';
        });
    }

    // Chart refresh
    const refreshChart = document.getElementById('refreshChart');
    const chartLoader = document.getElementById('chartLoader');
    if (refreshChart) {
        refreshChart.addEventListener('click', function() {
            if (chartLoader) chartLoader.style.display = 'inline-block';
            setTimeout(() => {
                createChart(chartType);
                if (chartLoader) chartLoader.style.display = 'none';
            }, 1000);
        });
    }

    // Table sorting and filtering
    const sortSelect = document.getElementById('sortSelect');
    const filterInput = document.getElementById('filterInput');
    const marketTableBody = document.getElementById('marketTableBody');
    const refreshTable = document.getElementById('refreshTable');
    const tableLoader = document.getElementById('tableLoader');
    const lastUpdate = document.getElementById('lastUpdate');

    let marketData = {% if is_data_live %}
        [{% for coin_id, data in market_data.items %}
            {
                id: "{{ coin_id }}",
                name: "{{ data.name }}",
                price: {{ data.usd }},
                change: {{ data.usd_24h_change }},
                volume: {{ data.volume_24h }},
                sentiment: "{{ data.sentiment|default:'Neutral' }}"
            }{% if not forloop.last %},{% endif %}
        {% endfor %}]
    {% else %}
        []
    {% endif %};

    function renderTable(data) {
        if (!marketTableBody) return;
        
        marketTableBody.innerHTML = '';
        data.forEach((coin, index) => {
            const row = document.createElement('tr');
            row.className = 'animate-row';
            row.style = `--row-index: ${index};`;
            
            row.innerHTML = `
                <td>
                    <div class="d-flex align-items-center">
                        <div class="crypto-icon me-3">
                            <i class="fab fa-bitcoin" style="color: var(--accent-primary);"></i>
                        </div>
                        <div>
                            <a href="{% url 'live_charts' %}?coin=${coin.id}" class="coin-link fw-bold">
                                ${coin.name}
                            </a>
                            <div class="text-muted small">${coin.id.toUpperCase()}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="price-badge price-slide" data-coin="${coin.id}">
                        $${coin.price.toFixed(2)}
                    </span>
                </td>
                <td>
                    <span class="change-badge ${coin.change >= 0 ? 'change-positive' : 'change-negative'}" data-coin="${coin.id}">
                        ${coin.change >= 0 ? '+' : ''}${coin.change.toFixed(2)}%
                    </span>
                </td>
                <td class="text-secondary">$${coin.volume.toLocaleString()}</td>
                <td>
                    <span class="sentiment-badge sentiment-${coin.sentiment.toLowerCase()}" data-coin="${coin.id}">
                        ${coin.sentiment}
                    </span>
                </td>
                <td>
                    <a href="{% url 'live_charts' %}?coin=${coin.id}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-chart-area"></i>
                    </a>
                </td>
            `;
            marketTableBody.appendChild(row);
        });
    }

    function sortTable(criteria) {
        marketData.sort((a, b) => {
            if (criteria === 'name') {
                return a.name.localeCompare(b.name);
            } else if (criteria === 'price') {
                return b.price - a.price;
            } else if (criteria === 'change') {
                return b.change - a.change;
            } else if (criteria === 'volume') {
                return b.volume - a.volume;
            }
            return 0;
        });
        renderTable(marketData);
    }

    function filterTable(searchTerm) {
        const filteredData = marketData.filter(coin =>
            coin.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            coin.id.toLowerCase().includes(searchTerm.toLowerCase())
        );
        renderTable(filteredData);
    }

    if (sortSelect) {
        sortSelect.addEventListener('change', function() {
            sortTable(this.value);
        });
    }

    if (filterInput) {
        filterInput.addEventListener('input', function() {
            filterTable(this.value);
        });
    }

    if (refreshTable) {
        refreshTable.addEventListener('click', function() {
            if (tableLoader) tableLoader.style.display = 'inline-block';
            setTimeout(() => {
                if (lastUpdate) {
                    lastUpdate.textContent = new Date().toLocaleTimeString();
                }
                renderTable(marketData);
                if (tableLoader) tableLoader.style.display = 'none';
            }, 1000);
        });
    }

    // Initial table render
    renderTable(marketData);

    // Periodic data refresh
    setInterval(() => {
        if (tableLoader) tableLoader.style.display = 'inline-block';
        setTimeout(() => {
            marketData = marketData.map(coin => ({
                ...coin,
                price: coin.price * (1 + (Math.random() - 0.5) * 0.05),
                change: (Math.random() - 0.5) * 10,
                volume: coin.volume * (1 + (Math.random() - 0.5) * 0.1)
            }));
            sortTable(sortSelect?.value || 'name');
            if (lastUpdate) {
                lastUpdate.textContent = new Date().toLocaleTimeString();
            }
            if (tableLoader) tableLoader.style.display = 'none';
            
            if (currentChart) {
                currentChart.data.datasets[0].data = marketData.map(coin => coin.price);
                currentChart.update();
            }
        }, 1000);
    }, 30000);

    // Update market stats
    function updateMarketStats() {
        const totalCoins = document.getElementById('totalCoins');
        const marketCap = document.getElementById('marketCap');
        const totalVolume = document.getElementById('totalVolume');
        const marketSentiment = document.getElementById('marketSentiment');

        if (totalCoins) totalCoins.textContent = marketData.length;
        if (marketCap) {
            const totalCap = marketData.reduce((sum, coin) => sum + coin.price, 0);
            marketCap.textContent = `$${totalCap.toLocaleString(undefined, {maximumFractionDigits: 2})}`;
        }
        if (totalVolume) {
            const totalVol = marketData.reduce((sum, coin) => sum + coin.volume, 0);
            totalVolume.textContent = `$${totalVol.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
        }
        if (marketSentiment) {
            const avgChange = marketData.reduce((sum, coin) => sum + coin.change, 0) / marketData.length;
            marketSentiment.textContent = avgChange > 0 ? 'Bullish' : avgChange < 0 ? 'Bearish' : 'Neutral';
            marketSentiment.className = `stat-value ${avgChange > 0 ? 'positive' : avgChange < 0 ? 'negative' : ''}`;
        }
    }

    updateMarketStats();
    setInterval(updateMarketStats, 30000);
    {% endif %}
});
</script>
{% endblock %}
{% endblock %}